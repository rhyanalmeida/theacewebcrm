# üöÄ ACE CRM - RENDER.COM DEPLOYMENT GUIDE

## ‚ö†Ô∏è CRITICAL PRE-DEPLOYMENT FIXES REQUIRED

### üö® URGENT: Fix These Issues Before Deploying

1. **Backend Build Failures**: Multiple TypeScript compilation errors need fixing
2. **Frontend Dependencies**: Node modules permission issues 
3. **Missing Client Portal**: Client portal referenced in render.yaml but directory exists

---

## üìã PRE-DEPLOYMENT CHECKLIST

### ‚úÖ Step 1: Fix Backend TypeScript Issues

**CRITICAL**: The backend has 200+ TypeScript compilation errors that must be fixed:

```bash
cd src/
# Fix these critical issues:
# 1. JSX configuration in tsconfig.json
# 2. Missing service imports in analytics/index.ts
# 3. JWT token signing parameter issues
# 4. Joi validation schema errors
# 5. Supabase realtime type conflicts
```

**Required Actions:**
- [ ] Update tsconfig.json to handle JSX files
- [ ] Fix all import/export issues in analytics module
- [ ] Correct JWT service implementation
- [ ] Fix Joi schema validation
- [ ] Update Supabase realtime service

### ‚úÖ Step 2: Environment Variables Setup

**ALL REQUIRED ENVIRONMENT VARIABLES:**

#### üîß Backend Service Variables (ace-crm-backend)
```env
NODE_ENV=production
PORT=5000

# Supabase (REQUIRED)
SUPABASE_URL=https://hxcrjwrinexiyeyyyhfa.supabase.co
SUPABASE_ANON_KEY=[SECURE - Add in Render Dashboard]
SUPABASE_SERVICE_KEY=[SECURE - Add in Render Dashboard]

# JWT & Authentication (AUTO-GENERATED)
JWT_SECRET=[Generated by Render]
JWT_REFRESH_SECRET=[Generated by Render]  
SESSION_SECRET=[Generated by Render]

# Payments (REQUIRED)
STRIPE_SECRET_KEY=[SECURE - Add in Render Dashboard]
STRIPE_WEBHOOK_SECRET=[SECURE - Add in Render Dashboard]

# CORS Configuration
CORS_ORIGIN=https://ace-crm-frontend.onrender.com,https://ace-crm-portal.onrender.com
```

#### üåê Frontend Service Variables (ace-crm-frontend)
```env
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://ace-crm-backend.onrender.com/api
NEXT_PUBLIC_APP_URL=https://ace-crm-frontend.onrender.com
NEXT_PUBLIC_CLIENT_PORTAL_URL=https://ace-crm-portal.onrender.com
NEXT_PUBLIC_SUPABASE_URL=https://hxcrjwrinexiyeyyyhfa.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4Y3Jqd3JpbmV4aXlleXl5aGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDcyMTQsImV4cCI6MjA3MDA4MzIxNH0.UgHQzFICQqj5AAJty3PXqsEqL9s2NPRXyxIss1515M4
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=[SECURE - Add in Render Dashboard]
```

#### üè¢ Client Portal Variables (ace-crm-portal)
```env
NODE_ENV=production
NEXT_PUBLIC_API_URL=https://ace-crm-backend.onrender.com/api
NEXT_PUBLIC_APP_URL=https://ace-crm-portal.onrender.com
NEXT_PUBLIC_SUPABASE_URL=https://hxcrjwrinexiyeyyyhfa.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4Y3Jqd3JpbmV4aXlleXl5aGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDcyMTQsImV4cCI6MjA3MDA4MzIxNH0.UgHQzFICQqj5AAJty3PXqsEqL9s2NPRXyxIss1515M4
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=[SECURE - Add in Render Dashboard]
```

### ‚úÖ Step 3: Required Secrets to Obtain

**üîê Get These Before Deploying:**

1. **Supabase Service Key**: 
   - Go to https://app.supabase.com/project/hxcrjwrinexiyeyyyhfa/settings/api
   - Copy "service_role" key (NOT anon key)

2. **Stripe Keys**:
   - Go to https://dashboard.stripe.com/apikeys
   - Copy Secret Key (sk_test_... or sk_live_...)
   - Copy Publishable Key (pk_test_... or pk_live_...)

3. **Stripe Webhook Secret**:
   - Go to https://dashboard.stripe.com/webhooks
   - Create webhook pointing to: `https://ace-crm-backend.onrender.com/api/webhooks/stripe`
   - Copy webhook secret (whsec_...)

---

## üöÄ DEPLOYMENT STEPS

### Step 1: Create Render Account & Connect GitHub

1. Go to https://render.com and sign up
2. Connect your GitHub account
3. Grant access to your repository: `rhyanalmeida/theacewebcrm`

### Step 2: Deploy Using render.yaml (Blueprint)

1. In Render Dashboard, click "New +"
2. Select "Blueprint"
3. Connect to your GitHub repository
4. Select branch: `main` or `deploy-fix`
5. Render will automatically read `render.yaml` and create all services

### Step 3: Configure Environment Variables

**üî¥ CRITICAL: Add Secure Variables**

For each service, go to Settings ‚Üí Environment and add:

**Backend Service:**
- `SUPABASE_SERVICE_KEY` = [Your Supabase service key]
- `STRIPE_SECRET_KEY` = [Your Stripe secret key]  
- `STRIPE_WEBHOOK_SECRET` = [Your webhook secret]

**Frontend Service:**
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` = [Your Stripe publishable key]

**Client Portal:**
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` = [Your Stripe publishable key]

### Step 4: Monitor Deployment

1. Watch build logs for each service
2. Backend will fail until TypeScript errors are fixed
3. Frontend will fail if dependencies can't install
4. Client Portal will deploy successfully

---

## üîß BUILD COMMANDS VALIDATION

### Backend Build Process
```bash
# Current command (will fail):
npm install && npm run build

# Build process:
1. npm install - ‚úÖ Will work
2. tsc (TypeScript compile) - ‚ùå WILL FAIL - 200+ errors
3. Copy assets - ‚úÖ Will work if tsc succeeds

# Start command:
node dist/app.js
```

### Frontend Build Process  
```bash
# Current command:
npm install && npm run build

# Build process:
1. npm install - ‚ùå May fail due to permissions
2. next build - ‚ùå Will fail without dependencies

# Start command:
npm start -- --port $PORT
```

### Client Portal Build Process
```bash
# Current command:
npm install && npm run build

# Similar to frontend
# Start command:
npm start -- --port $PORT
```

---

## üéØ SERVICE CONFIGURATIONS

### Service Specifications (from render.yaml):

1. **Backend API** (ace-crm-backend)
   - Runtime: Node.js
   - Port: 5000
   - Health Check: `/health`
   - Plan: Starter ($7/month)

2. **Frontend Dashboard** (ace-crm-frontend)  
   - Runtime: Node.js
   - Health Check: `/api/health`
   - Plan: Starter ($7/month)

3. **Client Portal** (ace-crm-portal)
   - Runtime: Node.js  
   - Health Check: `/`
   - Plan: Starter ($7/month)

**Total Monthly Cost: $21/month (3 services √ó $7)**

---

## üö® CRITICAL PATH TO SUCCESS

### Phase 1: Fix Backend (BLOCKING)
```bash
# 1. Fix TypeScript compilation
cd src/
npm run build  # Must succeed without errors

# 2. Test locally
npm run start  # Must start without crashes
curl http://localhost:5000/health  # Must return 200
```

### Phase 2: Fix Frontend Dependencies  
```bash
# 1. Clear and reinstall
cd frontend/
rm -rf node_modules package-lock.json
npm install

# 2. Test build
npm run build  # Must complete successfully
npm start      # Must start on specified port
```

### Phase 3: Deploy to Render
```bash
# Only after Phases 1 & 2 succeed locally
# Push to main branch and deploy via Render Blueprint
```

---

## üîç POST-DEPLOYMENT VERIFICATION

### Health Checks
- [ ] Backend: https://ace-crm-backend.onrender.com/health
- [ ] Frontend: https://ace-crm-frontend.onrender.com/api/health  
- [ ] Portal: https://ace-crm-portal.onrender.com/

### Functional Testing
- [ ] Login system works
- [ ] Supabase connection established
- [ ] Stripe integration functioning
- [ ] API endpoints responding
- [ ] Real-time features working

---

## üìû TROUBLESHOOTING

### Build Failures
```bash
# Backend TypeScript errors:
- Check tsconfig.json JSX configuration
- Fix import/export statements
- Resolve type conflicts

# Frontend dependency issues:
- Clear node_modules and reinstall
- Check Node.js version compatibility
- Verify package.json scripts
```

### Runtime Issues
```bash
# Environment variables not loading:
- Verify all required vars are set in Render dashboard
- Check variable names match exactly
- Ensure secure variables are properly configured

# Service communication failures:
- Verify CORS settings include all service URLs
- Check API endpoints are correctly configured
- Confirm health checks are responding
```

---

## üìä DEPLOYMENT TIMELINE

**Total Estimated Time: 4-6 hours**

- ‚úÖ Environment setup: 30 minutes
- üî¥ **Backend fixes: 2-3 hours (CRITICAL PATH)**
- ‚ö†Ô∏è Frontend fixes: 1 hour  
- üöÄ Render deployment: 30 minutes
- üß™ Testing & verification: 1 hour

**Current Status: üî¥ BLOCKED by backend TypeScript compilation errors**

---

## üéâ SUCCESS CRITERIA

‚úÖ **Ready for Production When:**
- [ ] All TypeScript compilation errors resolved
- [ ] All three services build successfully locally
- [ ] Environment variables documented and secured
- [ ] Render services deployed and healthy
- [ ] End-to-end functionality verified
- [ ] Payment processing tested
- [ ] User authentication working

**Next Steps: Fix the 200+ TypeScript errors in the backend to unblock deployment.**